<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ghausia Mosque Prayer Time</title>
<style>
  body { 
    margin:0; 
    font-family:sans-serif; 
    background: #006400 url('https://upload.wikimedia.org/wikipedia/commons/6/6e/Mosque_Sunset.jpg') no-repeat center center fixed;
    background-size: cover;
    color:#eee; 
  }
  header { padding:1rem; background:rgba(0,0,0,0.8); position:sticky; top:0; }
  h1 { margin:0; font-size:18px; }
  .tabs { margin-top:.5rem; display:flex; gap:.5rem; }
  .tab { background:#333; color:#eee; padding:.4rem .7rem; border-radius:5px; cursor:pointer; }
  .tab.active { background:#0f0; color:#000; font-weight:bold; }
  main { padding:1rem; }
  .card { background:rgba(0,0,0,0.8); padding:1rem; border-radius:8px; margin-bottom:1rem; }
  input,button,textarea { padding:.5rem; border-radius:5px; border:none; }
  input,textarea { background:#333; color:#eee; width:100%; }
  button { background:#0f0; color:#000; font-weight:bold; cursor:pointer; }
  button.secondary { background:#444; color:#eee; }
  table { width:100%; border-collapse:collapse; margin-top:.5rem; font-size:14px; }
  th,td { border:1px solid #444; padding:.3rem; text-align:center; }
  td[contenteditable="true"] { background:#333; }
  tr.today { background:#0f03; } /* highlight today */
  .hide { display:none; }
  #hadithBox { background:#111; padding:1rem; margin:1rem; border-radius:8px; font-style:italic; }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

<!-- PapaParse for robust CSV parsing -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

</head>
<body>
<header>
  <h1>Ghausia Mosque Prayer Time</h1>
  <div class="tabs">
    <button class="tab active" data-tab="public">Prayer Times</button>
    <button class="tab" data-tab="admin">Admin</button>
  </div>
</header>

<section id="hadithBox" class="card">
  <h3>Hadith of the Month</h3>
  <div id="hadithText">No hadith set yet.</div>
</section>

<main>
  <section id="public" class="card">
    <div id="todayBox"></div>
    <div id="tableWrap"></div>
  </section>

  <section id="admin" class="card hide">
    <div id="adminGate">
      <input id="email" type="email" placeholder="Admin Email" />
      <input id="pwd" type="password" placeholder="Password" />
      <button id="loginBtn">Login</button>
      <div id="loginMsg" style="color:red; display:none;">Wrong credentials or not authorized</div>
    </div>

    <div id="adminArea" class="hide">
      <input id="csvInput" type="file" accept=".csv" />
      <button id="saveBtn">Save Table</button>
      <hr>
      <h3>Edit Hadith of the Month</h3>
      <textarea id="hadithInput" rows="3" placeholder="Type new hadith..."></textarea>
      <button id="saveHadithBtn">Save Hadith</button>
    </div>
  </section>
</main>

<script>
// ---------------- FIREBASE CONFIG ----------------
const firebaseConfig = {
  apiKey: "AIzaSyDtrSvVSBZBASmn-f2SnqzWQDTpa9OSFA8",
  authDomain: "ghausia-mosque.firebaseapp.com",
  projectId: "ghausia-mosque",
  storageBucket: "ghausia-mosque.firebasestorage.app",
  messagingSenderId: "967127501442",
  appId: "1:967127501442:web:31e3397f238bee9792c29b",
  measurementId: "G-1207G9PLRJ"
};
const app = firebase.initializeApp(firebaseConfig);
const analytics = firebase.analytics();
const db = firebase.database();
const auth = firebase.auth();

// Only this UID can access admin functions
const ADMIN_UID = "zfdCu8n5thWBEPWyqkPbAixA3Ho2";

// ---------------- DATA ----------------
function saveData(rows){ db.ref("timetable").set(rows); }
function loadData(callback){ db.ref("timetable").once("value").then(snap=>callback(snap.val()||[])); }
function saveHadith(text){ db.ref("hadith").set(text); }
function loadHadith(callback){ db.ref("hadith").once("value").then(snap=>callback(snap.val()||"No hadith set yet.")); }

// ---------------- RENDER ----------------
function renderToday(rows){
  if(!rows.length){ document.getElementById("todayBox").innerHTML="No data yet."; return; }
  const today = new Date().getDate();
  let row = rows.find(r=>parseInt(r.Date)==today) || rows[rows.length-1];
  let html = `<h3>Today's Times (Day ${row.Date})</h3>`;
  for(let k in row){ if(k!=="Date") html += `<div><b>${k}:</b> ${row[k]}</div>`; }
  document.getElementById("todayBox").innerHTML = html;
}
function renderTable(rows){
  if(!rows.length){ document.getElementById("tableWrap").innerHTML=""; return; }
  const headers = Object.keys(rows[0]||{});
  let thead = `<tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr>`;
  let tbody = rows.map(r=>{
    const isToday = parseInt(r.Date) === new Date().getDate();
    return `<tr class="${isToday?'today':''}">${headers.map(h=>`<td contenteditable="${h!=='Date'}">${r[h]}</td>`).join("")}</tr>`;
  }).join("");
  document.getElementById("tableWrap").innerHTML = `<table>${thead}${tbody}</table>`;
  renderToday(rows);
}
function renderHadith(text){ document.getElementById("hadithText").innerText=text; }

// ---------------- TABS ----------------
const publicTab = document.getElementById("public");
const adminTab = document.getElementById("admin");
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    if(btn.dataset.tab==="public"){
      publicTab.classList.remove("hide");
      adminTab.classList.add("hide");
    } else {
      publicTab.classList.add("hide");
      adminTab.classList.remove("hide");
    }
  });
});

// ---------------- AUTH ----------------
document.getElementById("loginBtn").onclick=()=>{
  const email=document.getElementById("email").value;
  const pwd=document.getElementById("pwd").value;
  auth.signInWithEmailAndPassword(email,pwd)
    .then(cred=>{
      if(cred.user.uid === ADMIN_UID){
        document.getElementById("adminGate").classList.add("hide");
        document.getElementById("adminArea").classList.remove("hide");
      } else {
        auth.signOut();
        document.getElementById("loginMsg").style.display="block";
      }
    })
    .catch(()=>{ document.getElementById("loginMsg").style.display="block"; });
};

// ---------------- CSV UPLOAD ----------------
document.getElementById("csvInput").onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    trimHeaders: true,
    complete: function(results) {
      const rows = results.data.map(row=>{
        const cleanRow = {};
        for(let k in row){ cleanRow[k.trim()] = row[k].trim(); }
        return cleanRow;
      });
      saveData(rows);
      renderTable(rows);
      alert("CSV uploaded successfully!");
    },
    error: function(err){
      alert("Error parsing CSV: " + err.message);
    }
  });
};

// ---------------- SAVE TABLE ----------------
document.getElementById("saveBtn").onclick=()=>{
  const rows=[];
  const headers=[...document.querySelectorAll("#tableWrap th")].map(th=>th.textContent);
  document.querySelectorAll("#tableWrap table tr").forEach((tr,i)=>{
    if(i===0) return;
    const cells=[...tr.children];
    const row={};
    cells.forEach((td,j)=>{ row[headers[j]]=td.textContent.trim(); });
    rows.push(row);
  });
  saveData(rows);
  alert("Saved!");
};

// ---------------- SAVE HADITH ----------------
document.getElementById("saveHadithBtn").onclick=()=>{
  const newHadith=document.getElementById("hadithInput").value.trim();
  if(newHadith){ saveHadith
